<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>工蜂小智 </title>
    <meta name="description" content="QQ营销">
    <meta name="keywords" content="index">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="renderer" content="webkit">
    <meta http-equiv="Cache-Control" content="no-siteapp"/>
    <link rel="icon" type="image/png" href="../assets/i/favicon.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/i/favicon.png">
    <meta name="apple-mobile-web-app-title" content="工蜂小智"/>
    <link rel="stylesheet" href="/app/static/js/plugs/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="../assets/css/amazeui.min.css"/>
    <link rel="stylesheet" href="../assets/css/admin.css">
    <link rel="stylesheet" href="../assets/css/app.css">
    <link rel="stylesheet" href="/app/static/css/base.css">
    <style>
        .am-form-label {
            font-size: 16px;
        }

        .input {
            padding: .5em;
            font-size: 1.6rem;
            line-height: 1.2;
            color: #555;
            vertical-align: middle;
            background-color: #fff;
            background-image: none;
            border: 1px solid #ccc !important;
            border-radius: 0;
            -webkit-appearance: none;
            -webkit-transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;
            transition: border-color .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;
            transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;
            transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out, -webkit-box-shadow .15s ease-in-out;
        }

        .hive-4 {
            width: 40%;
            float: left;
        }

        .hive-6 {
            width: 60%;
            float: left;
        }

        @media only screen and (max-width: 1640px) {
            .hive-6, .hive-4 {
                width: 100%;
                margin-bottom: 20px;
            }
        }

    </style>
</head>
<body data-type="generalComponents">
<div class="tpl-page-container tpl-page-header-fixed">
    <div class="tpl-content-wrapper">
        <div class="tpl-portlet-components">
            <ul class="am-nav am-nav-tabs">
                <li><a href="../wechat/index.html"><span class="am-icon-weixin"></span> 微信营销</a></li>
                <li><a href="../wechat/fission.html"><span class="am-icon-weixin"></span> 微信裂变</a></li>
                <li class="am-active"><a href="../qq/index.html"><span class="am-icon-qq"></span> QQ营销</a></li>
                <li><a href="../qq/fission.html"><span class="am-icon-qq"></span> QQ裂变</a></li>
            </ul>
            <div class="hive-tip am-hide">QQ营销功能未开通，点击<a>立即开通</a></div>
            <div class="am-g am-margin-top">
                <div class="am-form">
                    <div>
                        <button type="button" class="am-btn am-btn-sm am-btn-warning" onclick="checkLoginQQ(null)"
                                id="loginBtn">
                            登录QQ
                        </button>
                        <b class="am-form-label">QQ账号：</b>
                        <input type="number" class="input am-input-sm" style="width: 150px;display: initial;"
                               placeholder="QQ账号" id="qqAcc">
                        <b class="am-form-label">QQ密码：</b>
                        <input type="text" class="input am-input-sm" style="width: 150px;display: initial;"
                               placeholder="QQ密码" id="qqPwd">
                        <b class="am-form-label">问候语：</b>
                        <input type="text" class="input am-input-sm" style="width: 250px;display: initial;"
                               placeholder="问候语" id="qqRemark">
                        <button type="button" class="am-btn am-btn-sm am-btn-primary" id="saveAccount">
                            <i class="am-icon-save"></i> 保存
                        </button>
                        <br>
                        <br>
                    </div>
                    <div class="hive-4">
                        <b class="am-form-label">QQ群关键词：</b>
                        <input type="text" class="input am-input-sm"
                               style="width: 280px;display: initial;"
                               placeholder="QQ群关键词" id="keyword">
                        <button type="button" class="am-btn am-btn-sm" id="searchQQGroup"><span
                                class="am-icon-search"></span> 搜索
                        </button>
                        <!--*<select id="province" class="am-form-select" placeholder="-- 省份 --"
                                style="width: 150px;float: none;    display: initial;">
                            <option value=" ">-- 所有省份 --</option>
                        </select>
                        <select id="city" class="am-form-select" placeholder="-- 城市 --"
                                style="width: 150px;float: none;    display: initial;">
                            <option value=" ">-- 所有城市 --</option>
                        </select>
                        <select id="area" placeholder="-- 区 --" style="width: 150px;float: none;display: initial;">
                            <option value=" ">-- 所有区 --</option>
                        </select>
                        <select id="plate" placeholder="-- 县 --" style="width: 150px;float: none;display: initial;">
                            <option value=" ">-- 所有县 --</option>
                        </select>-->
                    </div>
                    <div class="hive-6">
                        <b class="am-form-label">加群/群发设置：</b>
                        <span class="am-form-label">每加/发群：
                               <input type="text" id="groupCount" class="input am-input-sm"
                                      style="width: 80px;display: initial;"
                                      placeholder="3" value="3"> 次
                        </span>
                        <span class="am-form-label">延迟：
                               <input type="text" id="sleepTime" class="input am-input-sm"
                                      style="width: 80px;display: initial;"
                                      placeholder="30" value="30"> 秒后再加
                        </span>
                        <button type="button" class="am-btn am-btn-sm am-btn-secondary"
                                onclick="checkLoginQQ(sendQQMsg)">
                            <span class="am-icon-location-arrow"></span> QQ群发
                        </button>
                        <button type="button" class="am-btn am-btn-sm am-btn-success" id="StartAddQQGroup"><span
                                class="am-icon-plus"></span> 启动QQ加群
                        </button>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="am-u-md-12 row-mb">
                    <div style="overflow-y: auto;max-height: 400px;">
                        <table class="am-table tpl-table">
                            <thead>
                            <tr class="tpl-table-uppercase">
                                <th width="100">QQ</th>
                                <th width="100">头像</th>
                                <th width="100">群名称</th>
                                <th>描述</th>
                            </tr>
                            </thead>
                            <tbody id="searchQQGroupList">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="am-u-md-6 am-u-sm-12 row-mb am-padding-0">
                    <div class="tpl-portlet">
                        <div class="tpl-portlet-title">
                            <div class="tpl-caption font-red ">
                                <i class="am-icon-qq"></i>
                                <span> QQ好友</span>
                            </div>
                            <div class="actions">
                                <ul class="actions-btn">
                                    <li class="green" onclick="getLoginQQInfo()">刷新</li>
                                </ul>
                            </div>
                        </div>
                        <div class="tpl-scrollable">
                            <div class="number-stats">
                                <div class="stat-number am-fl am-u-md-6">
                                    <div class="title am-text-right"> 总共好友</div>
                                    <div class="number am-text-right am-text-warning" id="UserCount"> 0</div>
                                </div>
                            </div>
                            <div style="overflow-y: auto;height: 400px;">
                                <table class="am-table tpl-table">
                                    <thead>
                                    <tr class="tpl-table-uppercase">
                                        <th>QQ</th>
                                        <th>昵称</th>
                                    </tr>
                                    </thead>
                                    <tbody id="qqList">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="am-u-md-6 am-u-sm-12 row-mb am-padding-0">
                    <div class="tpl-portlet">
                        <div class="tpl-portlet-title">
                            <div class="tpl-caption font-red ">
                                <i class="am-icon-users"></i>
                                <span> QQ群</span>
                            </div>
                            <div class="actions">
                                <ul class="actions-btn">
                                    <li onclick="getQQGroupMembers()">
                                        <span class="am-icon-arrow-down"></span>
                                        获取全部QQ群成员
                                    </li>
                                    <li class="blue" onclick="addQQUser()">
                                        <span class="am-icon-plus"></span>
                                        添加全部QQ群成员
                                    </li>
                                    <li class="green" onclick="getLoginQQInfo()">刷新</li>
                                </ul>
                            </div>
                        </div>
                        <div class="tpl-scrollable">
                            <div class="number-stats">
                                <div class="stat-number am-fl am-u-md-6">
                                    <div class="title am-text-right"> Total</div>
                                    <div class="number am-text-right am-text-warning" id="GroupCount"> 0</div>
                                </div>
                            </div>

                            <div style="overflow-y: auto;height: 400px;">
                                <table class="am-table tpl-table">
                                    <thead>
                                    <tr class="tpl-table-uppercase">
                                        <th>群QQ</th>
                                        <th>群名称</th>
                                    </tr>
                                    </thead>
                                    <tbody id="qqGroupList">
                                    </tbody>
                                </table>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="tpl-alert"></div>
    </div>
</div>
</div>

<script src="../assets/js/jquery.min.js"></script>
<script src="../assets/js/amazeui.min.js"></script>
<script src="../assets/js/app.js"></script>
<script src="/app/static/js/plugs/layui/layui.all.js"></script>
<script src="../assets/js/common.ajax.js"></script>
<script src="../assets/js/common.js"></script>
<script>
    $(function () {
        getLoginQQInfo();
        cancelLoginQQ();
        qqFuncStatus();
        getQQAccount();
        $("#StartAddQQGroup").click(function () {
            var groupCount = $("#groupCount").val() || 3, sleepTime = $("#sleepTime").val() || 30;
            var qqAcc = $("#qqAcc").val(), qqPwd = $("#qqPwd").val(), qqRemark = $("#qqRemark").val();
            $.ajax({
                url: "/qq/add/group",
                data: {groupCount: groupCount, sleepTime: sleepTime, qq: qqAcc, pwd: qqPwd, remark: qqRemark},
                success: function (d) {
                    layer.msg(d.msg, {icon: 1})
                }
            });
        });
        $("#saveAccount").click(function () {
            var qqAcc = $("#qqAcc").val(), qqPwd = $("#qqPwd").val(), qqRemark = $("#qqRemark").val();
            $.ajax({
                url: "/qq/account/save",
                data: {qq: qqAcc, pwd: qqPwd, remark: qqRemark},
                success: function (d) {
                    layer.msg(d.msg, {icon: 1})
                }
            });
        });
        $("#searchQQGroup").click(function () {
            $("#searchQQGroupList").html('');
            var keyword = $("#keyword").val();
            search(keyword, 0, 0)
        });
    });

    function getQQAccount() {
        $.ajax({
            url: "/qq/account/get",
            success: function (d) {
                if (d.data != null && d.data.length) {
                    for (var i in d.data) {
                        $("#qqAcc").val(d.data[i].platform_account);
                        $("#qqPwd").val(d.data[i].platform_password);
                        $("#qqRemark").val(d.data[i].remark);
                    }
                }
            }
        });
    }

    function search(keyword, city, page) {
        $.ajax({
            url: "/qq/search/group",
            data: {keyword: keyword, city: city, page: page},
            success: function (d) {
                if (d.data.group_list != undefined && d.data.group_list != null && d.data.gTotal > 0) {
                    bindSearchList(d.data.group_list)
                    if (page < Math.ceil(d.data.gTotal / 24) && page < 7) {
                        page++;
                        setTimeout(function () {
                            search(keyword, city, page)
                        }, 500);
                    }
                }
            }
        });
    }

    function bindSearchList(info) {
        var temp = "<tr><td>{gid}</td><td><img src=\"{url}\" alt=\"\" class=\"user-pic\"></td><td>{Name}</td><td>{richfingermemo}</td></tr>";
        for (var i in info) {
            $("#searchQQGroupList").append(temp.replace("{url}", info[i].url)
                    .replace("{gid}", info[i].gid)
                    .replace("{Name}", info[i].Name)
                    .replace("{richfingermemo}", info[i].richfingermemo))
        }
    }


    function getLoginQQInfo() {
        $.ajax({
            url: "/qq/login/check",
            success: function (d) {
                if (d.data != null && d.data.QQUser.Status) {
                    var temp = "<tr data-id='{id}'><td>{img}{QQ}</td><td>{Nick}</td></tr>";
                    var info = d.data.QQUser.FriendsMap2
                    var i = 0;
                    $("#qqList").html('')
                    for (var u in info) {
                        $("#qqList").append(temp.replace("{img}", "<img src='http://q4.qlogo.cn/g?b=qq&nk=" + info[u].QQ +
                                "&s=140' class='user-pic'/> ").replace("{id}", info[u].QQ).replace("{QQ}", info[u].QQ).replace("{Nick}", info[u].NiceName))
                        i++;
                    }
                    $("#UserCount").html(" " + i);
                    temp = "<tr data-id='{id}'><td>{img}{QQ}</td><td>{Nick}</td><td class='handle'></td></tr>";
                    i = 0;
                    info = d.data.QQUser.Group2Map
                    $("#qqGroupList").html('')
                    for (var u in info) {
                        $("#qqGroupList").append(temp.replace("{id}", info[u].gc).replace("{img}", "<img src=" + info[u].Logo + " class=\"user-pic\"> ")
                                .replace("{QQ}", info[u].gc)
                                .replace("{Nick}", info[u].gn))
                        i++;
                    }
                    $("#GroupCount").html(" " + i);
                    $("#loginBtn").html("已登录【" + d.data.QQUser.Login.Nickname + "】");
                    $("#loginBtn").addClass("am-btn-success");
                    $("#loginBtn").removeClass("am-btn-warning");
                    //群
                    bindSearchList(d.data.QQUser.SearchGroup.group_list)
                    $("#keyword").val(d.data.QQUser.SearchKeyWord);
                    //群成员
                    info = d.data.QQUser.GroupMembersMap
                    if (info != null) {
                        $.each($("#qqGroupList tr"), function (i, item) {
                            var qq = $(item).attr("data-id");
                            if (info[qq] != null && info[qq] != undefined) {
                                $(item).find(".handle").html("<a  data-layer='members.html?qq=" + qq +
                                        "' data-layer-w='500px' " +
                                        "data-layer-h='70%' data-layer-title='【" + $(item).find("td:eq(1)").html() + "】群成员'>查看成员</a>" +
                                        "&nbsp;&nbsp;<a class='am-text-success' onclick='addQQUser(" + qq + ")'>添加群成员</a>"
                                )
                            }
                        });
                    }
                } else {
                    $("#loginBtn").html("登录QQ");
                }
            }
        });
    }


    var sendStatus = false;
    var checkStatus = true;

    function checkLoginQQ(func) {
        $.ajax({
            load_tip: false,
            url: "/qq/login/check",
            success: function (d) {
                if (d.data != null && d.data.QQUser.Status) {
                    layer.confirm('当前登录账号：【' + d.data.QQUser.Login.Nickname + '】', {
                        btn: ['切换账号', '继续'] //按钮
                    }, function () {
                        loginQQ(func)
                    }, function () {
                        if (func != null) {
                            func()
                        }
                    });
                } else {
                    loginQQ(func)
                }
            }
        });
    }

    function loginQQ(func) {
        $.ajax({
            url: "/qq/login",
            success: function (d) {
                openQrCode(d.data, func)
            }
        });
    }

    function cancelLoginQQ() {
        $.ajax({
            url: "/qq/cancel/login"
        });
    }


    function sendQQMsg() {
        layer.prompt({title: '请输入QQ群发消息内容', formType: 2}, function (text, index) {
            if (text == "") {
                layer.msg('请输入发送内容');
                return
            }
            layer.close(index);
            $.ajax({
                url: "/qq/send/message",
                data: {msg: text},
                success: function (d) {
                    layer.msg(d.msg)
                }
            });
        });
    }

    function getQQGroupMembers() {
        var trGroup = $("#qqGroupList tr");
        if (trGroup.length > 0) {
            getQQGroupMember(0, trGroup)
        }
    }

    function getQQGroupMember(i, trGroup) {
        var qq = $(trGroup[i]).attr("data-id")
        $.ajax({
            url: "/qq/group/members",
            data: {qq: qq},
            success: function (d) {
                $(trGroup[i]).find(".handle").html("<a data-layer=''>查看成员</a>&nbsp;&nbsp;<a onclick='addQQUser(" + qq + ")'>添加群成员</a>")
            },
            complete: function () {
                i++;
                if (i < trGroup.length) {
                    setTimeout(function () {
                        getQQGroupMember(i, trGroup)
                    }, 1000);
                }
            }
        });
    }

    function addQQUser(gqq) {
        var groupCount = $("#groupCount").val() || 3, sleepTime = $("#sleepTime").val() || 30;
        var qqAcc = $("#qqAcc").val(), qqPwd = $("#qqPwd").val(), qqRemark = $("#qqRemark").val();
        $.ajax({
            url: "/qq/add/qq",
            data: {gqq: gqq, groupCount: groupCount, sleepTime: sleepTime, qq: qqAcc, pwd: qqPwd, remark: qqRemark},
            success: function (d) {
                layer.msg(d.msg, {icon: 1})
            }
        });
    }

    var qrcodeLayer;

    function openQrCode(qrcode, func) {
        checkStatus = true
        qrcodeLayer = layer.open({
            type: 1,
            title: "请用手机QQ扫一扫二维码登录",
            offset: '10px',
            area: '400px',
            closeBtn: false,
            shade: 0.8,
            id: 'LAY_layuipro',
            btn: ['取消发送'],
            moveType: 1,//拖拽模式，0或者1  ,
            content: '<div style="padding: 50px; line-height: 22px; background-color: #393D49; color: #fff; font-weight: 300;padding-bottom: 10px;">' +
            '<img src="' + qrcode + '" style="display:black;width: 100%;"><div style="text-align:center">' +
            '<pre id="sendStatusMsg">扫码登录</pre></div></div>',
            yes: function () {
                cancelLoginQQ()
                checkStatus = false;
                layer.close(qrcodeLayer)
            },
            cancel: function () {
                cancelLoginQQ()
                checkStatus = false;
                layer.close(qrcodeLayer)
            }
        });
        getQQStatus(func)
    }


    function getQQStatus(func) {
        $.ajax({
            load_tip: false,
            url: "/qq/status",
            success: function (d) {
                sendStatus = d.data.sendStatus
                if (!sendStatus && checkStatus) {
                    $("#sendStatusMsg").html(d.data.sendStatusMsg);
                    setTimeout(function () {
                        getQQStatus(func)
                    }, 300)
                } else {
                    if (sendStatus == 1) {
                        getLoginQQInfo()
                        layer.close(qrcodeLayer)
                        if (func != null) {
                            func()
                        }
                    }
                }
            }
        });
    }

    function qqFuncStatus() {
        $.ajax({
            load_tip: false,
            url: "/qq/funcStatus",
            success: function (d) {
                if (!d.data) {
                    $(".hive-tip").removeClass("am-hide");
                    getAccount(function (acc) {
                        $(".hive-tip a").attr("href", "http://pay.9ee3.com?fid=7&token=" + acc.account.Token +
                                "&backUrl=" + encodeURIComponent(acc.host + "?lastUrl=/app/page/admin/qq/index.html"))
                    });
                }
            }
        });
    }
</script>
</body>
</html>