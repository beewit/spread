<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>工蜂小智 - </title>
    <meta name="description" content="这是一个 index 页面">
    <meta name="keywords" content="index">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="renderer" content="webkit">
    <meta http-equiv="Cache-Control" content="no-siteapp"/>
    <link rel="icon" type="image/png" href="assets/i/favicon.png">
    <link rel="apple-touch-icon-precomposed" href="assets/i/app-icon72x72@2x.png">
    <meta name="apple-mobile-web-app-title" content="工蜂小智"/>
    <link rel="stylesheet" href="/app/static/js/plugs/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="assets/css/amazeui.min.css"/>
    <link rel="stylesheet" href="assets/css/app.css">
    <link rel="stylesheet" href="/app/static/css/func.css">
</head>

<body data-type="index">
<div class="tpl-page-container tpl-page-header-fixed">
    <div class="tpl-content-wrapper">
        <ol class="am-breadcrumb">
            <li><a href="#" class="am-icon-home">首页</a></li>
        </ol>
        <div class="tpl-content-scope">
            <div class="note note-info">
                <h3>工蜂小智 - 新一代智能化营销工作平台
                    <span class="close" data-close="note"></span>
                    <span class="am-fr">
                        <small>客服电话：</label><b style="color:#00bd52;font-size:30px;">023-66224924</b></span>
                </h3>
                <p> 工蜂小智 具有数据分发、可视分发工具、营销解决方案，体验优秀的营销工作平台，大幅提升工作效率。</p>
                <p><span class="label label-danger">提示:</span> 工蜂小智 - 1个人顶10个人用，减少人力成本！。
                </p>
            </div>
        </div>
        <div class="row">
            <div class="am-u-lg-3 am-u-md-6 am-u-sm-12">
                <div class="dashboard-stat blue">
                    <div class="visual">
                        <i class="am-icon-comments-o"></i>
                    </div>
                    <div class="details">
                        <div class="number" id="openFunc"> --个</div>
                        <div class="desc"> 已开通功能</div>
                    </div>
                    <a class="more" href="#"> 查看全部
                        <i class="m-icon-swapright m-icon-white"></i>
                    </a>
                </div>
            </div>
            <div class="am-u-lg-3 am-u-md-6 am-u-sm-12">
                <div class="dashboard-stat red">
                    <div class="visual">
                        <i class="am-icon-bar-chart-o"></i>
                    </div>
                    <div class="details">
                        <div class="number" id="notExpireFunc"> --个</div>
                        <div class="desc"> 待续费功能</div>
                    </div>
                    <a class="more" href="#"> 点击续费
                        <i class="m-icon-swapright m-icon-white"></i>
                    </a>
                </div>
            </div>
            <div class="am-u-lg-3 am-u-md-6 am-u-sm-12">
                <div class="dashboard-stat green">
                    <div class="visual">
                        <i class="am-icon-apple"></i>
                    </div>
                    <div class="details">
                        <div class="number"> --条</div>
                        <div class="desc"> 今日分发数量</div>
                    </div>
                    <a class="more" href="#"> 统计反馈
                        <i class="m-icon-swapright m-icon-white"></i>
                    </a>
                </div>
            </div>
            <div class="am-u-lg-3 am-u-md-6 am-u-sm-12">
                <div class="dashboard-stat purple">
                    <div class="visual">
                        <i class="am-icon-android"></i>
                    </div>
                    <div class="details">
                        <div class="number"> --条</div>
                        <div class="desc"> 总分发数量</div>
                    </div>
                    <a class="more" href="#"> 查看记录
                        <i class="m-icon-swapright m-icon-white"></i>
                    </a>
                </div>
            </div>
        </div>
        <div class="row am-margin-bottom">
            <div class="am-u-sm-12 func-nav">
                <div class="func-type">
                    <span>类型：</span>
                    <a class="active">全部</a>
                    <!--<a>数据群发</a>-->
                    <!--<a>爬虫</a>-->
                </div>
                <div class="func-batch">
                        <span class="am-margin-right-lg">
                            <i class="am-icon-bell-o" style="color:#ff9004"></i>    温馨提示：开通越多优惠越大！
                        </span>
                    <button type="button" class="am-btn am-btn-sm am-btn-warning am-round am-btn-xs" id="func-batch"><i
                            class="am-icon-shopping-cart"></i> 批量开通 <b id="cartSum" class="am-badge am-round"
                                                                       style="background-color:#fff;color: #f37b1d;">0</b></button>
                    <input type="hidden" id="cartIds" value="">
                </div>
            </div>
        </div>
        <div class="row">
            <ul class="func" id="func-view">

            </ul>
        </div>
        <div class="am-cf">
            <div class="am-fr" id="page">
            </div>
        </div>
    </div>
</div>
<script id="list" type="text/html">
    {{#  layui.each(d.Data, function(index, item){ }}
    <li>
        <div class="func-item {{ AfterTime(item.expiration_time) }}" data-id="{{ item.id }}">
            <div class="func-content {{ item.tip=='HOT'?'hot':'' }} {{ item.tip=='NEW'?'new':'' }}">
                <section class="func-header">
                    <a>
                        <img class="func-icon" src="{{ item.cover_img }}">
                    </a>
                    <div class="func-header-corp">
                        <a>{{ item.name }}</a>
                        <div class="price"><b class="am-margin-right func-price">&yen; {{ item.price }}/天</b></div>
                        <div class="desc">{{ item.remarks }}</div>
                    </div>
                    <div class="func-handle">
                        <span class="openFunc">{{ AfterTime(item.expiration_time)=='expire'?'续费':'开通' }}</span>
                        <span class="addCart {{ checkFuncCartClass(item.id) }}"> {{ checkFuncCart(item.id) }}</span>
                        <span class="time">到期时间：{{ GetExpirationTime(item.expiration_time) }}</span>
                    </div>
                </section>
                <section class="func-tag">
                    {{ SplitCode(item.code) }}
                </section>
            </div>
        </div>
    </li>
    {{#  }); }}
    {{#  if(d == null){ }}
    无数据
    {{#  } }}
</script>
<script src="assets/js/jquery.min.js"></script>
<script src="assets/js/jquery.fly.min.js"></script>
<script src="/app/static/js/plugs/layui/layui.all.js"></script>
<script src="assets/js/common.js"></script>
<script src="assets/js/common.ajax.js"></script>
<script>
    var laytpl, laypage;
    var getTpl = list.innerHTML, view = document.getElementById('func-view');
    var pageIndex = 1;
    $(function () {
        layui.use(['laytpl', 'laypage'], function () {
            laytpl = layui.laytpl;
            laypage = layui.laypage;
            loadFunc(pageIndex);
        });

        $("#func-view").delegate(".openFunc", "click", function () {
            var id = $(this).parents(".func-item").attr("data-id");
            getAccount(function (acc) {
                location.href = "http://pay.9ee3.com?fid=" + id + "&token=" + acc.account.Token +
                    "&backUrl=" + encodeURIComponent(acc.host +
                        "?lastUrl=/app/page/admin/index.html")
            })
        });
        $("#func-view").delegate(".addCart", "click", function (event) {
            if ($(this).hasClass("disabled")) {
                var sum = $("#cartSum").html() || 0;
                $("#cartSum").html(parseInt(sum) - 1)
                $(this).removeClass("disabled")
                $(this).html("加入开通")
                remCartId($(this).parents(".func-item").attr("data-id"))
            } else {
                if (!$(this).hasClass("no")) {
                    $(this).addClass("no")
                    $(this).addClass("disabled")
                    $(this).html("取消开通")
                    addCart(this, event)
                }
            }
        });

        $("#func-batch").click(function () {
            var fid = $("#cartIds").val();
            if (fid == "") {
                layer.msg("请选择要开通的功能", {icon: 0})
                return
            }
            getAccount(function (acc) {
                location.href = "http://pay.9ee3.com?fid=" + fid + "&token=" + acc.account.Token + "&backUrl=" +
                    encodeURIComponent(acc.host +
                        "?lastUrl=/app/page/admin/index.html")
            })
        });
    });

    function checkFuncCartClass(id) {
        if (checkFuncCart(id) == "取消开通") {
            return "disabled"
        }
        return ""
    }

    function checkFuncCart(id) {
        var fid = $("#cartIds").val();
        if (("," + fid + ",").indexOf("," + id + ",") > -1) {
            return "取消开通"
        }
        return "加入开通"
    }

    function addCart(obj, event) {
        var offset = $("#cartSum").offset(); //结束的地方的元素
        var flyer = $('<span class="am-badge am-badge-warning am-round" style="font-size: 2rem;">1</span>');
        flyer.fly({
            start: {
                left: event.pageX,
                top: event.pageY
            },
            end: {
                left: offset.left,
                top: offset.top - $(document).scrollTop(),
                width: 0,
                height: 0
            },
            onEnd: function () {
                var sum = $("#cartSum").html() || 0;
                $("#cartSum").html(parseInt(sum) + 1);
                $(obj).removeClass("no");
                $(obj).parents(".func-item").attr("data-id");
                addCartId($(obj).parents(".func-item").attr("data-id"))
                this.destory();
                layer.tips('加入购物车成功，可点击批量开通', '#cartSum', {
                    tips: [1, '#78BA32']
                });
            }
        });
    }

    function addCartId(id) {
        var $cartIds = $("#cartIds");
        var fid = $cartIds.val();
        if (fid == "") {
            $cartIds.val(id);
        } else {
            var flog = false;
            var ids = new Array();
            var str = fid.split(",");
            for (var i = 0; i < str.length; i++) {
                ids.push(str[i])
                if (id == str[i]) {
                    flog = true;
                }
            }
            if (!flog) {
                ids.push(id)
            }
            $cartIds.val(ids.join(","));
        }
    }

    function remCartId(id) {
        var $cartIds = $("#cartIds");
        var fid = $cartIds.val();
        if (fid != "") {
            var ids = new Array();
            var str = fid.split(",");
            for (var i = 0; i < str.length; i++) {
                if (id != str[i]) {
                    ids.push(str[i])
                }
            }
            $cartIds.val(ids.join(","));
        }
    }

    function loadFunc() {
        $.ajax({
            url: "/api/func/list",
            data: {pageIndex: pageIndex},
            success: function (d) {
                if (d.ret == 200) {
                    if(d.data.group.ret==200){
                        $("#openFunc").html(d.data.group.data.openMap.length+" 个");
                        $("#notExpireFunc").html(d.data.group.data.notExpireMap.length+" 个");
                    }

                    laytpl(getTpl).render(d.data, function (html) {
                        view.innerHTML = html;
                    });
                    //总页数大于页码总数
                    laypage.render({
                        elem: 'page',
                        count: d.data.Count,
                        limit: d.data.PageSize,
                        curr: d.data.pageIndex,
                        jump: function (obj, first) {
                            //首次不执行
                            if (!first) {
                                pageIndex = obj.curr
                                loadFunc()
                            }
                        }
                    });
                }
            }
        });
    }
</script>
</body>

</html>